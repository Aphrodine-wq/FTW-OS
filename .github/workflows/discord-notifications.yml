name: Discord Notifications

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    types: [ opened, synchronize, closed ]
  workflow_dispatch:

jobs:
  notify-discord:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get commit info
        id: commit-info
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            COMMIT_MSG="${{ github.event.pull_request.title }}"
            COMMIT_AUTHOR="${{ github.event.pull_request.user.login }}"
            COMMIT_SHA="${{ github.event.pull_request.head.sha }}"
            COMMIT_URL="${{ github.event.pull_request.html_url }}"
            BRANCH="${{ github.event.pull_request.head.ref }}"
            ACTION="${{ github.event.action }}"
          else
            COMMIT_MSG="${{ github.event.head_commit.message }}"
            COMMIT_AUTHOR="${{ github.event.head_commit.author.name }}"
            COMMIT_SHA="${{ github.event.head_commit.id }}"
            COMMIT_URL="${{ github.event.head_commit.url }}"
            BRANCH="${GITHUB_REF#refs/heads/}"
            ACTION="pushed"
          fi
          
          # Get changed files
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            CHANGED_FILES=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.event.pull_request.head.sha }} | head -10 | tr '\n' ', ' | sed 's/,$//')
          else
            CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD | head -10 | tr '\n' ', ' | sed 's/,$//')
          fi
          
          echo "commit_msg<<EOF" >> $GITHUB_OUTPUT
          echo "$COMMIT_MSG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          echo "commit_author=$COMMIT_AUTHOR" >> $GITHUB_OUTPUT
          echo "commit_sha=${COMMIT_SHA:0:7}" >> $GITHUB_OUTPUT
          echo "commit_url=$COMMIT_URL" >> $GITHUB_OUTPUT
          echo "branch=$BRANCH" >> $GITHUB_OUTPUT
          echo "action=$ACTION" >> $GITHUB_OUTPUT
          echo "changed_files=$CHANGED_FILES" >> $GITHUB_OUTPUT

      - name: Send Discord notification
        if: always()
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
          REPO_NAME: ${{ github.repository }}
          BRANCH_NAME: ${{ steps.commit-info.outputs.branch }}
          ACTION_TYPE: ${{ steps.commit-info.outputs.action }}
          COMMIT_AUTHOR: ${{ steps.commit-info.outputs.commit_author }}
          COMMIT_SHA: ${{ steps.commit-info.outputs.commit_sha }}
          COMMIT_URL: ${{ steps.commit-info.outputs.commit_url }}
          COMMIT_MSG: ${{ steps.commit-info.outputs.commit_msg }}
          CHANGED_FILES: ${{ steps.commit-info.outputs.changed_files }}
        run: |
          # Determine color based on event type
          if [ "${{ github.event_name }}" = "pull_request" ] && [ "${{ github.event.action }}" = "closed" ]; then
            COLOR=3066993  # Green for merged PRs
          elif [ "${{ github.event_name }}" = "pull_request" ]; then
            COLOR=3447003  # Blue for PRs
          else
            COLOR=5763719  # Green for pushes
          fi
          
          # Escape JSON special characters in commit message and changed files
          ESCAPED_MSG=$(echo "$COMMIT_MSG" | sed 's/"/\\"/g' | sed ':a;N;$!ba;s/\n/\\n/g')
          ESCAPED_FILES=$(echo "$CHANGED_FILES" | sed 's/"/\\"/g' | sed ':a;N;$!ba;s/\n/\\n/g')
          
          # Build the embed JSON
          EMBED_JSON=$(cat <<EOF
          {
            "username": "GitHub Bot",
            "avatar_url": "https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png",
            "embeds": [{
              "title": "ðŸš€ Git Activity Detected",
              "description": "**Repository:** ${REPO_NAME}\n**Branch:** ${BRANCH_NAME}\n**Action:** ${ACTION_TYPE}\n**Author:** ${COMMIT_AUTHOR}\n**Commit:** [\`${COMMIT_SHA}\`](${COMMIT_URL})\n**Message:** ${ESCAPED_MSG}\n\n**Changed Files:**\n${ESCAPED_FILES}",
              "color": ${COLOR},
              "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
              "footer": {
                "text": "GitHub Actions"
              }
            }]
          }
          EOF
          )
          
          # Send to Discord
          curl -H "Content-Type: application/json" \
               -d "$EMBED_JSON" \
               "$DISCORD_WEBHOOK"

